pipeline {
  agent any
  stages {
  stage ('SCM CHECKOUT') {
    steps {
      git branch: 'Yahia_ModuleFornisseur', url: 'https://github.com/yassinedarwezi/DevOps.git' 
    }}

      stage ('compile and test ') {
   steps {

         sh 'mvn -version'
         sh 'mvn compile'
   }
      }
    stage('package'){
            steps {
	    
	        sh 'chmod +x mvnw'
                sh 'mvn clean package -DskipTests'
            }
        }
	
                stage('test'){
            steps {
                sh 'mvn test'
            }
	    }
        
        stage("sonar"){
        steps {
                withSonarQubeEnv ( installationName: 'SonarQube-8.9.7'){
                  sh """./mvnw sonar:sonar \
                -Dsonar.projectKey=Achat \
                -Dsonar.host.url=http://127.0.0.1:9000/ \
                -Dsonar.coverage.jacoco.xmlReportPaths=../target/site/jacoco-aggregate/jacoco.xml """
                }
        }
        } 
        	stage("Publish to Nexus Repository Manager") {
            steps {
                 nexusArtifactUploader artifacts: [
                     [
                         artifactId: 'tpAchatProject',
                         classifier: '',
                         file: 'target/tpAchatProject-1.0.jar',
                         type: 'jar']], 
                     credentialsId: 'nexus3',
                     groupId: 'com.esprit.examen', 
                     nexusUrl: '127.0.0.1:8081', 
                     nexusVersion: 'nexus3', 
                     protocol: 'http',
                     repository: 'springboot',
                     version: '1.0'
            }
              }
        
        stage('Build docker image'){
 steps{
 script{
 sh 'docker build -t hayoosnoussi/springprojet .'
 }
 }
 }
  stage('Docker login') {

 steps {
 sh 'echo "login Docker ...."'
sh 'docker login -u hayoosnoussi -p hayoobeats'
  }  }

 stage('Docker push') {
 steps {
 sh 'echo "Docker is pushing ...."'
sh 'docker push hayoosnoussi/springprojet'
 }  }
 
 stage       ('Docker compose') {
             steps {
                sh 'docker compose up -d '
            }
        } 
	
      }
}
